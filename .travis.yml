language: go
go:
- 1.8.x
dist: trusty
sudo: false
node_js:
- '7'
addons:
  apt:
    sources:
    - sourceline: ppa:masterminds/glide
    - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
      key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
    - sourceline: ppa:ubuntu-toolchain-r/test
    - sourceline: deb https://deb.nodesource.com/setup_7.x trusty main
      key_url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    packages:
    - glide
    - yarn
    - build-essential
install:
- cd ${TRAVIS_BUILD_DIR}
- glide install
- go get github.com/mjibson/esc
- go get github.com/ahmetb/govvv
- go get github.com/franciscocpg/gox
- go get github.com/tcnksm/ghr
- go get github.com/sanbornm/go-selfupdate
- go get github.com/jteeuwen/go-bindata/...
- go get github.com/elazarl/go-bindata-assetfs/...
script:
- cd ${TRAVIS_BUILD_DIR} && go generate
- VERSION=$(cat ./VERSION)
- echo "VERSION = ${VERSION}"
- DIST=${TRAVIS_BUILD_DIR}/dist/dockerfile-builder/stable
- CGO_ENABLED=0 gox -verbose  -os="linux darwin windows" -arch="amd64" -osarch="!darwin/arm64
  linux/ppc64 linux/ppc64le" -ldflags="$(govvv -flags) -s -w -X main.AppSecret=${APP_SECRET}
  -extldflags \"-static\"" -output="${DIST}/${VERSION}/{{.OS}}-{{.Arch}}/{{.Dir}}"
  .
before_deploy:
- echo "go-selfupdate generating bindiffs"
- mkdir -p ${DIST}/${VERSION}/binaries
- mkdir -p ${DIST}/latest
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/darwin-amd64   ${DIST}/${VERSION}/darwin-amd64/dockerfile-builder      ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-amd64    ${DIST}/${VERSION}/linux-amd64/dockerfile-builder       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-ppc64le  ${DIST}/${VERSION}/linux-ppc64le/dockerfile-builder     ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/windows-amd64  ${DIST}/${VERSION}/windows-amd64/dockerfile-builder.exe
  ${TRAVIS_BUILD_DIR}/LICENSE.TXT ${TRAVIS_BUILD_DIR}/VERSION
- go-selfupdate -o ${DIST}/updates ${DIST}/${VERSION}/binaries/ ${VERSION}
- cp ${DIST}/${VERSION}/binaries/darwin-amd64  ${DIST}/latest/darwin-amd64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-amd64   ${DIST}/latest/linux-amd64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-ppc64le ${DIST}/latest/linux-ppc64le.tar.gz
- cp ${DIST}/${VERSION}/binaries/windows-amd64 ${DIST}/latest/windows-amd64.tar.gz
- rm -fr ${DIST}/${VERSION}/binaries
- echo "Copying latest directory to ${DIST}/${TRAVIS_COMMIT}"
- cp -r ${DIST}/latest ${DIST}/${TRAVIS_COMMIT}
after_deploy:
- cf logs dockerfile-builder --recent
- echo "releasing v${VERSION}..."
- ghr -t "$GITHUB_TOKEN" -u rai-project -r dockerfile-builder --replace "v${VERSION}"
  "${DIST}/latest"
- cd ${TRAVIS_BUILD_DIR}
deploy:
- provider: bluemixcloudfoundry
  edge: true
  api: https://api.ng.bluemix.net
  username: "$BLUEMIX_USERNAME"
  password: "$BLUEMIX_PASSWORD"
  organization: IBM-ILLINOIS-C3SR
  space: dev
  manifest: manifest.yml
  on:
    repo: rai-project/dockerfile-builder
- provider: s3
  access_key_id: AKIAIAFSJLCCOYB5V3EQ
  secret_access_key:
    secure: SmAJqNftOvfIClayyLJalKqkdvx/AU1ovDsDTXXgC3rTDT4JyuVUejyQYO2OCDZzMq4WAtZ1zhhNngy7T5E3LUhpUXCsOP1PaxGUkdLVPWbZ9I0SsPZbJ8u/UUyaMNlDNfumlPs9iQhhmwIAJ6ryHIzlcGbqVSGA8BPg77rLdbV4RTxEmOeICpcO1egs/7/FqCRUMTJm3765tzWKdDfCfUKImuDlif2lYmY6ED+gTNBJr2qgJ08QnJwyxnqdPoZVGdOFWE+wV1YbsdL7hkelbXlRab6ofRgd2BoyeD3X1lUBQQEISS8HEpmoH5PdrCGXwz/szWhZfdMBJ0tYqLukr9dORHTkvhs0S78Sghj/gj/c1doudZnrt9PnpMm72ZJuUTfh+b3BLZ7heMLvaMVS9uu345eSVi7Diw/Hvqvl4c7CU0RoXl6MPLw1Q258D8HQABehMsaXBF/pkB4/DuU3oQWeE3dLSQLocKQyE6uJKHD4PYt859WKT6gz9KR/iYOG705Oo/x4R1un+t5oJjbjkf6Nh5OXVpUzrxBhcuhO+tb3azVA+5UQUr2iTw/uyibcHJq48h6piAnKbe4ALkY6nN/6PImoGJ0MbArNszXyckEccuvz4iX+R2Y/nE5SFdHIxBGR6iqX9SoGLP1KooM+Cn0MsnN3wCx++y7R7jk8cqQ=
  bucket: files.rai-project.com
  local-dir: dist
  upload-dir: dist
  acl: public_read
  skip_cleanup: true
  detect_encoding: true
  on:
    repo: rai-project/dockerfile-builder
env:
  global:
    secure: gA8eA1SRNgblZMWcWpLGm2d7fHKtfNL0FQoLSO83+lVIQ9Irg7rWlogsGH6W0gQrkFvsuycPsn9gCckSVDErzNNLEXx8AXxUwM6wQG3kLqFtpdHkCAPm8bTPsK5f+neypnie0zOuyMxyhdTw18dB+e5IeeMGHb55ThJMQpFa5GiGkU3BIuKqIp5hdEZgNw/VZfVW855NfdT+SwieJEb9SmijpebySeXOy6HJz92vBswcSywDmUvliFOjw8/ZlXF6DlD1hDeMBT34nhjorXrhr/DAmWuJE/kAHbmBMX0asmESct7uDjvRXIdb1UW55FSIJ+aj+c+oodpulMb0StL/Y+pVSl0YZhKX5C3D0EStX628B7aZlsR8Xw/unCv830Bpw7MeIMNG3BOlaxYzJyjcYxySMyXVtu/kebzqnY3fOPzOrs/XO2LdH04JPTGo+XntTXFh11JonBlAml1ukAuaJoOOrNWFdfnBy1RgF6qBPCog75Dfyz1aacIodM+0kFnKvV7P1kyXMw6IRXNj2LYFq2KI4F8YxAjP4Ykc3dhulV6zW1q8R4I/WkQfMAFH55WKvQ2CIIfYT1caNtqWDfOP8qauiLwHxBhspMKEBXP4cS4J4aa5r7EFwX+dBFZPuq0pRS8qVa5xQSs0nmVkLe7TzSFfj/DmtF4w61xhKX9g6Yg=
